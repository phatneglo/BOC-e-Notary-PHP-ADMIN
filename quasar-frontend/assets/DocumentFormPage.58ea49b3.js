import{c as ze,g as Be,r as h,h as j,a8 as pe,aA as C,ay as re,d as Ne,o as Me,j as b,B as $,D as r,l as a,n as F,k as L,w as n,aD as ee,y as Re,aY as we,C as Q,aB as A,J as he,F as Qe,H as Ge,L as Ie,I as ke,z as Fe,p as W,t as B,b5 as Ce,E as te,s as De,G as ae,aI as Te,aJ as X,b2 as Oe,b4 as He,aX as Ae,aC as Ye,_ as Le,R as le,e as Je,f as Ke,az as Xe,bl as s,aK as qe,A as Ue,v as Se}from"./index.72b13dbe.js";import{Q as We}from"./QDate.fdadae78.js";import{Q as Ze}from"./QPopupProxy.1618197b.js";import{d as fe}from"./date.22c75b55.js";import{u as et}from"./document.bd69dba0.js";import{u as tt}from"./template.94583e77.js";import{s as Z}from"./formatters.87a426ac.js";import{D as Ee}from"./DocumentPreviewComponent.cf81bf6b.js";import{Q as $e}from"./QTooltip.942d6901.js";import"./document.f77d8b54.js";import"./axios.3c83b395.js";const Pe=(g,D)=>{if(D==null||D==="")return"";switch(g.field_type){case"date":return fe.formatDate(D,"MMMM D, YYYY");case"checkbox":return Array.isArray(D)?D.join(", "):D;case"select":return String(D);case"radio":return String(D);case"switch":return D?"Yes":"No";case"textarea":return Z(String(D));default:return String(D)}},at=g=>g.replace(/[.*+?^${}()|[\]\\]/g,"\\");function lt(g=null,D=null,P=null){const R=ze(),U=et(),S=tt(),T=Be(),z=h(null),Y=h(!0),E=h(!1),w=h(!1),f=h(null),v=h([]),p=h([]),c=h(""),de=h(""),K=h(!1),q=h(null),o=h({document_title:"",company_name:"",customs_entry_number:"",date_of_entry:fe.formatDate(new Date,"YYYY-MM-DD"),notes:"",document_data:{}}),G=j(()=>!!g),ue=j(()=>f.value&&f.value.is_custom),oe=j(()=>{const e={};v.value.forEach(t=>{const m=t.section_name||"Default";e[m]||(e[m]=[]),e[m].push(t)});for(const t in e)e[t].sort((m,y)=>(m.field_order||0)-(y.field_order||0));return e}),ne=j(()=>{const e=new Set(v.value.map(t=>t.section_name||"Default"));return Array.from(e).map(t=>({name:t}))}),I=j(()=>{if(!o.value.document_title)return!1;for(const e of v.value)if(e.is_required){const t=o.value.document_data[e.field_name];if(t==null||t===""||Array.isArray(t)&&t.length===0)return!1}return!0}),se=async()=>{Y.value=!0;try{if(g)await ie(g);else if(P)await l(P);else if(D)await i(D);else throw new Error("No template specified");_(),setTimeout(()=>{O()},500)}catch(e){console.error("Error initializing document form:",e),C.create({type:"negative",message:"Failed to load document information"})}finally{Y.value=!1}},ie=async e=>{try{console.log(`Loading existing document with ID: ${e}`);const t=await U.fetchDocument(e);if(!t)throw console.error("Document not found"),new Error("Document not found");if(console.log("Document loaded:",t),t.user_template_id)await l(t.user_template_id);else if(t.template_id)await i(t.template_id);else throw console.error("Document has no template associated with it"),new Error("Document has no template associated with it. Cannot edit.");o.value={document_title:t.document_title||"",company_name:t.company_name||"",customs_entry_number:t.customs_entry_number||"",date_of_entry:t.date_of_entry||fe.formatDate(new Date,"YYYY-MM-DD"),notes:t.notes||"",document_data:t.document_data||{}},console.log("Form data initialized:",o.value),await ce(e)}catch(t){throw console.error("Error loading existing document:",t),t}},l=async e=>{const t=await S.fetchUserTemplateDetails(e);if(f.value=t,t.template_id&&!t.is_custom){const m=await S.fetchTemplateDetails(t.template_id);v.value=m.fields||[]}},i=async e=>{console.log(`Loading template with id: ${e}`);try{const t=await S.fetchTemplateDetails(e);console.log("Template loaded:",t),f.value=t,t.fields&&Array.isArray(t.fields)?(v.value=t.fields,console.log(`${v.value.length} fields loaded from template:`,v.value)):(console.warn("No fields found in template or fields not in correct format"),v.value=[]),o.value.company_name&&v.value.some(m=>m.field_name==="company_name")&&(o.value.document_data.company_name=o.value.company_name)}catch(t){throw console.error("Error loading template:",t),t}},_=()=>{o.value.document_data||(o.value.document_data={}),!o.value.document_title&&f.value&&(o.value.document_title=f.value.custom_name||f.value.template_name),console.log("Template fields to initialize:",v.value),console.log("Current form data:",o.value.document_data),v.value.forEach(e=>{if(o.value.document_data[e.field_name]!==void 0)return;switch(e.field_type){case"text":case"textarea":case"email":case"tel":case"select":o.value.document_data[e.field_name]=e.default_value||"";break;case"number":o.value.document_data[e.field_name]=e.default_value?parseFloat(e.default_value):null;break;case"date":o.value.document_data[e.field_name]=e.default_value||null;break;case"radio":o.value.document_data[e.field_name]=e.default_value||(e.field_options&&e.field_options.length>0?e.field_options[0]:"");break;case"checkbox":o.value.document_data[e.field_name]=e.default_value?[e.default_value]:[];break;case"switch":o.value.document_data[e.field_name]=e.default_value==="true"||e.default_value===!0;break}const t=T.user;t&&(e.field_name.includes("first_name")&&!o.value.document_data[e.field_name]?o.value.document_data[e.field_name]=t.first_name:e.field_name.includes("last_name")&&!o.value.document_data[e.field_name]?o.value.document_data[e.field_name]=t.last_name:e.field_name.includes("email")&&!o.value.document_data[e.field_name]?o.value.document_data[e.field_name]=t.email:e.field_name.includes("address")&&!o.value.document_data[e.field_name]?o.value.document_data[e.field_name]=t.address||"":e.field_name.includes("phone")&&!o.value.document_data[e.field_name]&&(o.value.document_data[e.field_name]=t.mobile_number||""))})},ce=async e=>{try{const t=await re.get(`/documents/${e}/attachments`);t.data.success&&(p.value=t.data.data||[])}catch(t){console.error("Error loading attachments:",t),C.create({type:"negative",message:"Failed to load document attachments"})}},O=async()=>{if(!(!f.value||w.value)){w.value=!0;try{if(console.log("Generating preview, current template:",f.value),console.log("Current formData:",o.value),console.log("Current document_data:",o.value.document_data),g){const e=await re.get(`/documents/${g}/preview`);e.data.success&&(c.value=e.data.data.document_html,K.value=!1)}else me(),console.log("Server-side preview not available - using client-side preview")}catch(e){console.error("Error generating preview:",e),me(),C.create({color:"warning",message:"Using local preview - server preview not available"})}finally{w.value=!1}}},me=()=>{if(!f.value){c.value='<div class="text-center">Template not loaded</div>';return}let e=f.value.html_content||"";if(console.log("Template HTML content:",e),!e||e.trim()===""){e=`
        <div style="padding: 20px; font-family: Arial, sans-serif;">
          <h1 style="color: #1976d2;">${o.value.document_title||f.value.template_name}</h1>
          <hr style="border: 1px solid #e0e0e0; margin: 15px 0;">
          <div style="margin-bottom: 20px;">
            <p><strong>Date:</strong> ${fe.formatDate(new Date,"MMMM D, YYYY")}</p>
          </div>
      `;const t=v.value;if(t&&t.length>0){e+='<div style="margin-top: 20px;">';const m=oe.value;for(const y in m)y!=="Default"&&(e+=`<h2 style="color: #1976d2; margin-top: 30px;">${y}</h2>`),e+='<div style="margin-top: 10px;">',m[y].forEach(V=>{const x=o.value.document_data[V.field_name],N=Pe(V,x);if(x==null||x==="")return;let M=N;V.field_type==="textarea"&&M&&(M=M.replace(/\n/g,"<br>")),e+=`
              <div style="margin-bottom: 15px;">
                <div style="font-weight: bold; margin-bottom: 5px;">${V.field_label}:</div>
                <div style="padding: 5px 10px; background-color: #f5f5f5; border-radius: 4px;">
                  ${M}
                </div>
              </div>
            `}),e+="</div>";e+="</div>"}e+="</div>"}else{const t=o.value.document_data||{},m=/\{\{([^}]+)\}\}/g;let y,V=e;for(;(y=m.exec(e))!==null;){const x=y[0],N=y[1].trim();let M="";const ge=v.value.find(J=>J.field_name===N);if(t[N]!==void 0){const J=t[N];let ye=ge?Pe(ge,J):J;ge&&ge.field_type==="textarea"&&ye&&(ye=ye.replace(/\n/g,"<br>")),M=ye}else if(o.value[N]!==void 0){let J=o.value[N]||"";N==="notes"&&J&&(J=J.replace(/\n/g,"<br>")),M=J}V=V.replace(new RegExp(at(x),"g"),M)}e=V}c.value=e,K.value=!1,console.log("Client-side preview generated:",c.value)},be=(e,t)=>{typeof t=="string"&&(t=Z(t)),o.value.document_data[e]=t,console.log(`Field "${e}" changed to:`,t),console.log("Updated document_data:",o.value.document_data),q.value&&clearTimeout(q.value),q.value=setTimeout(()=>{console.log("Generating preview after field change..."),O()},500)},ve=e=>{p.value.push(e)},xe=async e=>{if(g&&e.attachment_id&&typeof e.attachment_id=="number")try{await re.delete(`/documents/${g}/attachments/${e.attachment_id}`)}catch(t){throw console.error("Error deleting attachment:",t),t}p.value=p.value.filter(t=>t!==e)},_e=async({documentId:e,file:t,description:m})=>{if(!(!e||!t||!m))try{const y=new FormData;y.append("description",m),y.append("is_supporting","true"),y.append("attachment",t);const V=await re.post(`/documents/${e}/attachments`,y);if(V.data.success){const x=V.data.data,N=p.value.findIndex(M=>M.file_name===t.name&&M.description===m);N!==-1?p.value[N]=x:p.value.push(x)}}catch(y){throw console.error("Error uploading attachment:",y),y}},Ve=async()=>{if(!o.value.document_title){C.create({type:"negative",message:"Document title is required"});return}E.value=!0;try{let e;return g?(await d(),e=g):e=(await u("draft")).document_id,C.create({type:"positive",message:"Document saved as draft"}),e}catch(e){throw console.error("Error saving document as draft:",e),C.create({type:"negative",message:"Failed to save document"}),e}finally{E.value=!1}},k=async()=>{if(z.value&&!await z.value.validate())return null;if(!o.value.document_title)return C.create({type:"negative",message:"Document title is required"}),null;E.value=!0;try{let e;return g?(await d(),e=g):e=(await u("draft")).document_id,C.create({type:"positive",message:"Document saved successfully"}),e}catch(e){return console.error("Error saving document:",e),C.create({type:"negative",message:"Failed to save document"}),null}finally{E.value=!1}},u=async(e="draft")=>{try{const t=Z(o.value.notes||""),m={...o.value.document_data};v.value.forEach(x=>{x.field_type==="textarea"&&m[x.field_name]&&(m[x.field_name]=Z(m[x.field_name]))});const y={template_id:D||(f.value?f.value.template_id:null),user_template_id:P||(f.value?f.value.user_template_id:null),document_title:o.value.document_title,company_name:o.value.company_name||null,customs_entry_number:o.value.customs_entry_number||null,date_of_entry:o.value.date_of_entry||null,document_data:m,notes:t,status:e};console.log("Creating document with sanitized data:",y);const V=await re.post("/documents",y);if(V.data.success){const x=V.data.data.document_id;return await H(x),V.data.data}else throw new Error(V.data.message||"Failed to create document")}catch(t){throw console.error("Error creating document:",t),t}},d=async(e=null)=>{if(!!g)try{const t=Z(o.value.notes||""),m={...o.value.document_data};v.value.forEach(x=>{x.field_type==="textarea"&&m[x.field_name]&&(m[x.field_name]=Z(m[x.field_name]))});const y={document_title:o.value.document_title,company_name:o.value.company_name||null,customs_entry_number:o.value.customs_entry_number||null,date_of_entry:o.value.date_of_entry||null,document_data:m,notes:t};e&&(y.status=e),console.log("Updating document with sanitized data:",y);const V=await re.put(`/documents/${g}`,y);if(!V.data.success)throw new Error(V.data.message||"Failed to update document");return V.data.data}catch(t){throw console.error("Error updating document:",t),t}},H=async e=>{const t=p.value.filter(m=>m.file);for(const m of t)await _e({documentId:e,file:m.file,description:m.description})},je=()=>{g?R.push(`/user/documents/${g}`):R.push("/user/templates")};return pe(()=>o.value,()=>{console.log("Form data changed, scheduling preview update..."),q.value&&clearTimeout(q.value),q.value=setTimeout(()=>{O()},500)},{deep:!0}),pe(()=>o.value.document_data,()=>{console.log("document_data specifically changed, updating preview..."),q.value&&clearTimeout(q.value),q.value=setTimeout(()=>{O()},300)},{deep:!0}),{isLoading:Y,isSaving:E,isLoadingPreview:w,previewHtml:c,previewUrl:de,isPdfPreview:K,currentTemplate:f,templateFields:v,attachments:p,formData:o,documentForm:z,isEdit:G,isCustomTemplate:ue,fieldsBySection:oe,uniqueSections:ne,isValid:I,initializeFormData:se,generatePreview:O,handleFieldChange:be,handleAddAttachment:ve,handleDeleteAttachment:xe,handleUploadAttachment:_e,saveAsDraft:Ve,saveAndContinue:k,goBack:je}}const ot={class:"document-attachments-manager"},nt={class:"row items-center justify-between q-mb-md"},st={class:"row items-center"},it={class:"text-h6"},rt={key:0,class:"full-height"},dt={class:"flex flex-center full-height"},ut={key:1,class:"full-height"},ct=["src"],mt={key:2,class:"flex flex-center full-height"},pt={class:"text-center"},ft=Ne({__name:"DocumentAttachmentsManager",props:{documentId:{type:[Number,String],default:null},attachments:{type:Array,default:()=>[]},disabled:{type:Boolean,default:!1}},emits:["add","delete","upload","update"],setup(g,{emit:D}){const P=g,R=D,U=h(!1),S=h(!1),T=h(!1),z=h(!1),Y=h(!1),E=h(!1),w=h(null),f=h(""),v=h(null),p=h({file:null,description:""}),c=j(()=>w.value?w.value.file_name:""),de=l=>l?fe.formatDate(new Date(l),"MMM D, YYYY h:mm A"):"",K=l=>l?l<1024?l+" bytes":l<1024*1024?(l/1024).toFixed(1)+" KB":(l/(1024*1024)).toFixed(1)+" MB":"0 bytes",q=l=>l?l.includes("pdf")?"fa-solid fa-file-pdf":l.includes("word")||l.includes("doc")?"fa-solid fa-file-word":l.includes("image")||l.includes("jpg")||l.includes("jpeg")||l.includes("png")?"fa-solid fa-file-image":"fa-solid fa-file":"fa-solid fa-file",o=l=>l?l.includes("pdf")?"negative":l.includes("word")||l.includes("doc")?"primary":l.includes("image")||l.includes("jpg")||l.includes("jpeg")||l.includes("png")?"teal":"grey":"grey",G=l=>!l||!l.file_type?!1:l.file_type.includes("pdf")||l.file_type.includes("image")||l.file_type.includes("jpg")||l.file_type.includes("jpeg")||l.file_type.includes("png"),ue=()=>{p.value={file:null,description:""},U.value=!0},oe=async()=>{if(!(v.value&&!await v.value.validate())&&!(!p.value.file||!p.value.description)){if(p.value.file.size>10*1024*1024){C.create({type:"negative",message:"File is too large. Maximum size is 10MB."});return}z.value=!0;try{const l={attachment_id:Date.now(),file_name:p.value.file.name,file_type:p.value.file.type,file_size:p.value.file.size,description:p.value.description,is_supporting:!0,uploaded_at:new Date().toISOString(),file:p.value.file};R("add",l),P.documentId&&R("upload",{documentId:P.documentId,file:p.value.file,description:p.value.description}),U.value=!1,C.create({type:"positive",message:"Document added successfully"})}catch(l){console.error("Error adding attachment:",l),C.create({type:"negative",message:"Failed to add document"})}finally{z.value=!1}}},ne=l=>{w.value=l,S.value=!0},I=()=>{if(!!w.value){Y.value=!0;try{R("delete",w.value),S.value=!1,w.value=null,C.create({type:"positive",message:"Document removed successfully"})}catch(l){console.error("Error deleting attachment:",l),C.create({type:"negative",message:"Failed to remove document"})}finally{Y.value=!1}}},se=async l=>{if(!!l){w.value=l,E.value=!0,f.value="",T.value=!0;try{l.file_path?f.value=l.file_path:l.file&&G(l)&&(f.value=URL.createObjectURL(l.file))}catch(i){console.error("Error generating preview:",i),f.value=""}finally{E.value=!1}}},ie=()=>{if(!!w.value){if(w.value.file_path)window.open(w.value.file_path,"_blank");else if(w.value.file){const l=URL.createObjectURL(w.value.file),i=document.createElement("a");i.href=l,i.download=w.value.file_name,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(l),document.body.removeChild(i)}}};return pe(U,l=>{l||(p.value={file:null,description:""})}),pe(S,l=>{!l&&!Y.value&&(w.value=null)}),pe(T,l=>{l||(w.value=null,f.value="")}),Me(()=>{}),(l,i)=>(b(),$("div",ot,[r("div",nt,[i[6]||(i[6]=r("div",{class:"text-h6"},"Supporting Documents",-1)),a(F,{color:"primary",unelevated:"",label:"Add Document",icon:"fa-solid fa-plus","no-caps":"",dense:"",onClick:ue,disable:g.disabled},null,8,["disable"])]),g.attachments.length===0?(b(),L(ee,{key:0,flat:"",bordered:"",class:"bg-grey-1 q-mb-md"},{default:n(()=>[a(A,{class:"text-center q-py-md"},{default:n(()=>[a(Q,{name:"fa-solid fa-file-circle-exclamation",size:"2em",color:"grey-6"}),i[7]||(i[7]=r("div",{class:"text-subtitle1 q-mt-sm"},"No supporting documents added yet",-1)),i[8]||(i[8]=r("div",{class:"text-caption text-grey-8"}," Add supporting documents required for your notarization ",-1))]),_:1})]),_:1})):(b(),L(Re,{key:1,separator:"",bordered:"",class:"rounded-borders q-mb-md"},{default:n(()=>[(b(!0),$(he,null,Qe(g.attachments,(_,ce)=>(b(),L(Ge,{key:_.attachment_id||ce},{default:n(()=>[a(ke,{avatar:""},{default:n(()=>[a(Ie,{color:o(_.file_type),"text-color":"white",icon:q(_.file_type)},null,8,["color","icon"])]),_:2},1024),a(ke,null,{default:n(()=>[a(Fe,null,{default:n(()=>[W(B(_.file_name),1)]),_:2},1024),a(Fe,{caption:""},{default:n(()=>[W(B(K(_.file_size))+" - "+B(de(_.uploaded_at)),1)]),_:2},1024),a(Fe,{caption:"",class:"text-primary"},{default:n(()=>[W(B(_.description),1)]),_:2},1024)]),_:2},1024),a(ke,{side:""},{default:n(()=>[r("div",st,[G(_)?(b(),L(F,{key:0,flat:"",round:"",color:"primary",icon:"fa-solid fa-eye",onClick:Ce(O=>se(_),["stop"])},{default:n(()=>[a($e,null,{default:n(()=>i[9]||(i[9]=[W("Preview Document")])),_:1})]),_:2},1032,["onClick"])):te("",!0),a(F,{flat:"",round:"",color:"negative",icon:"fa-solid fa-trash-alt",onClick:Ce(O=>ne(_),["stop"]),disable:g.disabled},{default:n(()=>[a($e,null,{default:n(()=>i[10]||(i[10]=[W("Delete Document")])),_:1})]),_:2},1032,["onClick","disable"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})),a(we,{modelValue:U.value,"onUpdate:modelValue":i[3]||(i[3]=_=>U.value=_),persistent:""},{default:n(()=>[a(ee,{style:{"min-width":"350px"}},{default:n(()=>[a(A,{class:"row items-center"},{default:n(()=>[i[11]||(i[11]=r("div",{class:"text-h6"},"Upload Supporting Document",-1)),a(De),ae(a(F,{icon:"fa-solid fa-times",flat:"",round:"",dense:""},null,512),[[le]])]),_:1}),a(A,null,{default:n(()=>[a(Te,{onSubmit:oe,ref_key:"uploadForm",ref:v},{default:n(()=>[a(X,{modelValue:p.value.description,"onUpdate:modelValue":i[0]||(i[0]=_=>p.value.description=_),label:"Description *",outlined:"",dense:"",rules:[_=>!!_||"Description is required"]},null,8,["modelValue","rules"]),a(Oe,{modelValue:p.value.file,"onUpdate:modelValue":i[2]||(i[2]=_=>p.value.file=_),label:"Select File *",outlined:"",dense:"",accept:".pdf,.doc,.docx,.jpg,.jpeg,.png",class:"q-mt-md",rules:[_=>!!_||"File is required"]},He({prepend:n(()=>[a(Q,{name:"fa-solid fa-file-upload"})]),_:2},[p.value.file?{name:"append",fn:n(()=>[a(Q,{name:"fa-solid fa-times",class:"cursor-pointer",onClick:i[1]||(i[1]=Ce(_=>p.value.file=null,["stop"]))})]),key:"0"}:void 0]),1032,["modelValue","rules"]),i[12]||(i[12]=r("div",{class:"text-caption text-grey-8 q-mt-xs"}," Supported formats: PDF, DOC, DOCX, JPG, PNG. Maximum file size: 10MB ",-1))]),_:1},512)]),_:1}),a(Ae,{align:"right"},{default:n(()=>[ae(a(F,{flat:"",label:"Cancel",color:"primary"},null,512),[[le]]),a(F,{unelevated:"",label:"Upload",color:"primary",onClick:oe,loading:z.value,disable:!p.value.file||!p.value.description},null,8,["loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(we,{modelValue:S.value,"onUpdate:modelValue":i[4]||(i[4]=_=>S.value=_)},{default:n(()=>[a(ee,null,{default:n(()=>[a(A,{class:"row items-center"},{default:n(()=>[i[13]||(i[13]=r("div",{class:"text-h6"},"Delete Supporting Document",-1)),a(De),ae(a(F,{icon:"fa-solid fa-times",flat:"",round:"",dense:""},null,512),[[le]])]),_:1}),a(A,null,{default:n(()=>i[14]||(i[14]=[r("p",null,"Are you sure you want to delete this supporting document?",-1),r("p",{class:"text-caption text-grey-8"},"This action cannot be undone.",-1)])),_:1}),a(Ae,{align:"right"},{default:n(()=>[ae(a(F,{flat:"",label:"Cancel",color:"primary"},null,512),[[le]]),a(F,{unelevated:"",label:"Delete",color:"negative",onClick:I,loading:Y.value},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(we,{modelValue:T.value,"onUpdate:modelValue":i[5]||(i[5]=_=>T.value=_),maximized:""},{default:n(()=>[a(ee,null,{default:n(()=>[a(A,{class:"row items-center q-py-sm bg-primary text-white"},{default:n(()=>[r("div",it,"Document Preview: "+B(c.value),1),a(De),a(F,{icon:"fa-solid fa-download",flat:"",round:"",dense:"",onClick:ie}),ae(a(F,{icon:"fa-solid fa-times",flat:"",round:"",dense:""},null,512),[[le]])]),_:1}),a(A,{class:"preview-section"},{default:n(()=>[E.value?(b(),$("div",rt,[r("div",dt,[a(Ye,{size:"3em",color:"primary"}),i[15]||(i[15]=r("span",{class:"q-ml-sm"},"Loading preview...",-1))])])):f.value?(b(),$("div",ut,[r("iframe",{src:f.value,class:"preview-iframe"},null,8,ct)])):(b(),$("div",mt,[r("div",pt,[a(Q,{name:"fa-solid fa-file-circle-exclamation",size:"3em",color:"grey-6"}),i[16]||(i[16]=r("div",{class:"text-h6 q-mt-md"},"Preview not available",-1)),i[17]||(i[17]=r("p",{class:"text-grey-8"},"This file type cannot be previewed directly.",-1)),a(F,{color:"primary",label:"Download File",icon:"fa-solid fa-download","no-caps":"",onClick:ie,class:"q-mt-sm"})])]))]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}});var vt=Le(ft,[["__scopeId","data-v-09efb33a"]]);const _t={class:"content-container q-pa-md q-pb-xl"},gt={class:"row items-center q-mb-md"},yt={class:"col"},wt={class:"text-h5 q-my-none"},ht={class:"text-grey-8 q-mb-none"},Dt={class:"col-auto"},bt={key:0,class:"q-pa-xl flex flex-center"},xt={key:2},Vt={class:"row q-col-gutter-md"},kt={class:"text-grey-8"},Ft={class:"row q-col-gutter-md"},Ct={class:"col-12"},qt={class:"col-12 col-md-6"},At={class:"col-12 col-md-6"},Ut={class:"col-12 col-md-6"},St={class:"row items-center justify-end"},Et={class:"col-12"},$t={key:0,class:"q-mb-md text-caption"},Pt={class:"row q-col-gutter-md"},zt={class:"row justify-end q-mt-md q-gutter-sm"},Nt=Ne({__name:"DocumentFormPage",setup(g){const D=Je(),P=ze(),R=Ke(),U=j(()=>D.params.id),S=j(()=>D.query.template_id),T=j(()=>D.query.user_template_id),z=h(!1),{isLoading:Y,isSaving:E,isLoadingPreview:w,currentTemplate:f,templateFields:v,attachments:p,formData:c,documentForm:de,previewHtml:K,previewUrl:q,isPdfPreview:o,isEdit:G,isCustomTemplate:ue,uniqueSections:oe,initializeFormData:ne,generatePreview:I,handleFieldChange:se,handleAddAttachment:ie,handleDeleteAttachment:l,handleUploadAttachment:i,saveAsDraft:_,saveAndContinue:ce,goBack:O}=lt(U.value,S.value,T.value),me=j(()=>R.screen.lt.md),be=()=>{z.value=!0},ve=k=>{window.open(`/documents/${k}/download`,"_blank")},xe=k=>{k&&(c.notes=Z(k))},_e=k=>{console.log("Syncing company name to document_data:",k),k&&v.length>0&&v.some(d=>d.field_name==="company_name")&&(c.document_data.company_name=k,console.log("Updated document_data.company_name:",c.document_data.company_name),I())},Ve=async()=>{const k=await ce();k&&P.push(`/user/document/${k}/review`)};return Me(async()=>{if(console.log("DocumentFormPage mounted, documentId:",U.value,"templateId:",S.value,"userTemplateId:",T.value),G){try{console.log("Edit mode - loading existing document"),await ne(),setTimeout(()=>{console.log("Initial preview generation in edit mode"),I()},500)}catch(k){console.error("Error loading document for editing:",k),C.create({type:"negative",message:"Failed to load document. Please try again.",timeout:5e3}),P.push("/user/inbox")}return}if(!S.value&&!T.value){console.log("No template specified, redirecting to template selection page"),C.create({type:"info",message:"Please select a template first",timeout:3e3}),P.push("/user/template-selection");return}try{await ne(),setTimeout(()=>{console.log("Initial preview generation in new document mode"),v.length>0&&(console.log("Template fields found:",v),c.company_name&&(c.document_data.company_name=c.company_name,console.log("Set company_name in document_data:",c.document_data.company_name)),I())},500)}catch(k){console.error("Error initializing document form:",k),C.create({type:"negative",message:"Failed to load template. Please try again.",timeout:3e3}),P.push("/user/template-selection")}}),(k,u)=>(b(),L(Xe,{class:"document-form-page bg-grey-1"},{default:n(()=>[r("div",_t,[r("div",gt,[r("div",yt,[r("h1",wt,B(s(G)?"Edit Document":"New Document"),1),r("p",ht,B(s(G)?"Update your document details":"Fill in the document details to create a new document"),1)]),r("div",Dt,[a(F,{outline:"",color:"primary",label:s(G)?"Back to Document":"Back",icon:"fa-solid fa-arrow-left","no-caps":"",onClick:s(O)},null,8,["label","onClick"])])]),s(Y)?(b(),$("div",bt,[a(Ye,{color:"primary",size:"3em"}),u[7]||(u[7]=r("span",{class:"q-ml-sm text-primary"},"Loading document form...",-1))])):s(f)?(b(),$("div",xt,[r("div",Vt,[r("div",{class:qe(["col-12",{"col-lg-6":!me.value}])},[a(ee,{flat:"",class:"bg-white"},{default:n(()=>[a(A,{class:"q-pb-none"},{default:n(()=>[u[11]||(u[11]=r("div",{class:"text-h6"},"Document Information",-1)),r("p",kt,[u[10]||(u[10]=W(" Template: ")),r("strong",null,B(s(f).custom_name||s(f).template_name),1)])]),_:1}),a(A,null,{default:n(()=>[a(Te,{onSubmit:Ve,ref_key:"documentForm",ref:de},{default:n(()=>[r("div",Ft,[r("div",Ct,[a(X,{modelValue:s(c).document_title,"onUpdate:modelValue":u[0]||(u[0]=d=>s(c).document_title=d),label:"Document Title *",outlined:"",dense:"","lazy-rules":"",rules:[d=>!!d||"Document title is required"]},{prepend:n(()=>[a(Q,{name:"fa-solid fa-file-alt"})]),_:1},8,["modelValue","rules"])]),r("div",qt,[a(X,{modelValue:s(c).company_name,"onUpdate:modelValue":[u[1]||(u[1]=d=>s(c).company_name=d),_e],label:"Company Name",outlined:"",dense:""},{prepend:n(()=>[a(Q,{name:"fa-solid fa-building"})]),_:1},8,["modelValue"])]),r("div",At,[a(X,{modelValue:s(c).customs_entry_number,"onUpdate:modelValue":u[2]||(u[2]=d=>s(c).customs_entry_number=d),label:"Customs Entry Number",outlined:"",dense:""},{prepend:n(()=>[a(Q,{name:"fa-solid fa-hashtag"})]),_:1},8,["modelValue"])]),r("div",Ut,[a(X,{modelValue:s(c).date_of_entry,"onUpdate:modelValue":u[4]||(u[4]=d=>s(c).date_of_entry=d),label:"Date of Entry",outlined:"",dense:"",readonly:""},{prepend:n(()=>[a(Q,{name:"fa-solid fa-calendar"})]),append:n(()=>[a(Q,{name:"fa-solid fa-calendar",class:"cursor-pointer"},{default:n(()=>[a(Ze,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:n(()=>[a(We,{modelValue:s(c).date_of_entry,"onUpdate:modelValue":u[3]||(u[3]=d=>s(c).date_of_entry=d)},{default:n(()=>[r("div",St,[ae(a(F,{label:"Close",color:"primary",flat:""},null,512),[[le]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),r("div",Et,[a(X,{modelValue:s(c).notes,"onUpdate:modelValue":[u[5]||(u[5]=d=>s(c).notes=d),xe],label:"Notes",outlined:"",type:"textarea",rows:"3"},{prepend:n(()=>[a(Q,{name:"fa-solid fa-sticky-note"})]),_:1},8,["modelValue"])])]),s(v).length>0?(b(),$(he,{key:0},[a(Ue,{class:"q-my-md"}),u[14]||(u[14]=r("div",{class:"text-h6 q-mb-md"},"Document Details",-1)),s(R).dev?(b(),$("div",$t,[r("div",null,"Fields available: "+B(s(v).length),1),r("pre",null,B(JSON.stringify(s(v),null,2)),1)])):te("",!0),r("div",Pt,[(b(!0),$(he,null,Qe(s(v),d=>(b(),$("div",{key:d.field_id,class:qe(d.field_width==="full"?"col-12":"col-12 col-md-6")},[d.field_type==="text"?(b(),L(X,{key:0,modelValue:s(c).document_data[d.field_name],"onUpdate:modelValue":[H=>s(c).document_data[d.field_name]=H,H=>s(se)(d.field_name,H)],label:d.field_label+(d.is_required?" *":""),outlined:"",dense:"",hint:d.help_text,placeholder:d.placeholder},{after:n(()=>[d.field_name==="company_name"&&s(c).document_data.company_name?(b(),L(Se,{key:0,color:"primary"},{default:n(()=>u[12]||(u[12]=[W(" Updated ")])),_:1})):te("",!0)]),_:2},1032,["modelValue","onUpdate:modelValue","label","hint","placeholder"])):d.field_type==="textarea"?(b(),L(X,{key:1,modelValue:s(c).document_data[d.field_name],"onUpdate:modelValue":[H=>s(c).document_data[d.field_name]=H,H=>s(se)(d.field_name,s(Z)(H))],label:d.field_label+(d.is_required?" *":""),outlined:"",type:"textarea",rows:3,hint:d.help_text,placeholder:d.placeholder},{after:n(()=>[d.field_name==="company_address"&&s(c).document_data.company_address?(b(),L(Se,{key:0,color:"primary"},{default:n(()=>u[13]||(u[13]=[W(" Updated ")])),_:1})):te("",!0)]),_:2},1032,["modelValue","onUpdate:modelValue","label","hint","placeholder"])):te("",!0)],2))),128))])],64)):te("",!0),s(ue)?te("",!0):(b(),$(he,{key:1},[a(Ue,{class:"q-my-md"}),a(vt,{"document-id":U.value,attachments:s(p),onAdd:s(ie),onDelete:s(l),onUpload:s(i)},null,8,["document-id","attachments","onAdd","onDelete","onUpload"])],64)),r("div",zt,[a(F,{label:"Save as Draft",color:"primary",outline:"","no-caps":"",onClick:s(_),loading:s(E)},null,8,["onClick","loading"]),a(F,{label:"Continue",color:"primary",unelevated:"","no-caps":"",type:"submit",loading:s(E)},null,8,["loading"])])]),_:1},512)]),_:1})]),_:1})],2),r("div",{class:qe(["col-12",{"col-lg-6":!me.value}])},[a(ee,{flat:"",class:"bg-white"},{default:n(()=>[a(A,{class:"q-pb-none"},{default:n(()=>u[15]||(u[15]=[r("div",{class:"text-h6"},"Document Preview",-1)])),_:1}),a(A,null,{default:n(()=>[a(Ee,{loading:s(w),"preview-html":s(K),"preview-url":s(q),"is-pdf-preview":s(o),"document-id":U.value,onGenerate:s(I),onFullscreen:be,onDownload:ve},null,8,["loading","preview-html","preview-url","is-pdf-preview","document-id","onGenerate"])]),_:1})]),_:1})],2)])])):(b(),L(ee,{key:1,flat:"",class:"bg-white"},{default:n(()=>[a(A,{class:"text-center q-pa-xl"},{default:n(()=>[a(Q,{name:"fa-solid fa-file-circle-exclamation",size:"3em",color:"grey-6"}),u[8]||(u[8]=r("div",{class:"text-h6 q-mt-md"},"Template Not Found",-1)),u[9]||(u[9]=r("p",{class:"text-grey-8"}," The requested template could not be found or loaded. ",-1)),a(F,{unelevated:"",color:"primary",label:"Select a Template",icon:"fa-solid fa-file-alt","no-caps":"",class:"q-mt-sm",to:"/user/template-selection"})]),_:1})]),_:1}))]),a(we,{modelValue:z.value,"onUpdate:modelValue":u[6]||(u[6]=d=>z.value=d),maximized:"",persistent:""},{default:n(()=>[a(ee,null,{default:n(()=>[a(A,{class:"row items-center q-py-sm bg-primary text-white"},{default:n(()=>[u[16]||(u[16]=r("div",{class:"text-h6"},"Document Preview",-1)),a(De),ae(a(F,{icon:"fa-solid fa-times",flat:"",round:"",dense:""},null,512),[[le]])]),_:1}),a(A,{class:"full-preview-container"},{default:n(()=>[a(Ee,{loading:s(w),"preview-html":s(K),"preview-url":s(q),"is-pdf-preview":s(o),"document-id":U.value,onGenerate:s(I),onDownload:ve},null,8,["loading","preview-html","preview-url","is-pdf-preview","document-id","onGenerate"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});var Ht=Le(Nt,[["__scopeId","data-v-79da1c06"]]);export{Ht as default};
